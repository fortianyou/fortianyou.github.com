<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  
<meta name="baidu-site-verification" content="8L0CBcKMlB" />
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.2"/>


    <meta name="description" content="不积跬步无以至千里，不积小流无以成江海" />



  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/images/books.png?v=0.4.2" />




  <title> 知耻而后勇 </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">知耻而后勇</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="/categories">
          <i class="menu-item-icon icon-categories"></i> <br />
          分类
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          标签
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <div id="posts" class="posts-expand">
    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/06/07/how-to-do-gibbs-sampling/">
                如何做Gibbs采样(how to do gibbs-sampling)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-06-07
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/LDA/">LDA</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/06/07/how-to-do-gibbs-sampling/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/06/07/how-to-do-gibbs-sampling/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h3 id="随机模拟">随机模拟</h3><p>　　随机模拟（或者统计模拟）方法最早有数学家乌拉姆提出，又称做蒙特卡洛方法。蒙特卡洛是一个著名的赌场，赌博总是和统计有着密切的关系，所以这个命名风趣而贴切，被广为接受。<br>　　随机模拟的一个重要问题就是给定一个概率分布$p(x)$，如何生成它的样本。均匀分布$Uniform(0,1)$的样本可以通过线性同余发生器生成的伪随机数来模拟。常见的概率分布，无论是离散的还是连续的分布，都可以基于$Uniform(0,1)$的样本经过变换生成。<br>　　然而，当概率分布$p(x)$的形式很复杂或者$p(x)$是个高维分布的时候，样本的生成就会变得困难。此时就需要一些更加复杂的随机模拟方法来生成样本。接下来将会介绍下MCMC(Markov Chain Monte Carlo)和Gibbs Sampling算法。</p>
<h4 id="马尔科夫链及其平稳分布">马尔科夫链及其平稳分布</h4><p>马尔科夫链的数学定义如下：<br>$$P(X_{t+1}=x| X_t, X_{t-1},…) = P(X_{t+1}| X_t)$$<br>_定理_ 如果一个非周期马尔科夫链具有转移概率矩阵$P$，且它的任何两个状态是连通的，那么</p>
<ol>
<li>$\lim_{n\rightarrow \infty}{P^n}=<br>\left[<br>\begin{array}{ccccc}<br>\pi(1) &amp; \pi(2) &amp;…&amp;\pi(j)&amp;…\\<br>\pi(1) &amp; \pi(2) &amp;…&amp;\pi(j)&amp;…\\<br>…&amp;…&amp;…&amp;…&amp;…\\<br>\pi(1) &amp; \pi(2) &amp;…&amp;\pi(j)&amp;…\\<br>…&amp;…&amp;…&amp;…&amp;…\\<br>\end{array}<br>\right].<br>$</li>
<li>$\pi(j)=\sum_{i=0}^{\infty}{\pi(i)P_{ij}}$.</li>
<li>$\pi$是方程$\pi P=\pi$的唯一非负解，其中$\pi =[\pi(1), \pi(2), …, \pi(j), …], \sum_{i=0}^{\infty}{\pi_i} = 1.$<br>$\pi$称为马尔科夫链的平稳分布。</li>
</ol>
<h5 id="_收敛到平稳分布_">_收敛到平稳分布_</h5><p>从初始概率分布$\pi_0$出发，我们在马尔科夫链上做状态转移，记$X_i$的概率分布为$\pi_i$，则有<br>$$\begin{array}{cc}<br>X_0\sim \pi_0(x)&amp; \\<br>X_i\sim \pi_i(x),&amp; \pi_i(x) = \pi_{i-1}(x)P=\pi_0(x)P^i<br>\end{array}<br>$$<br>由马尔科夫链收敛的定理，概率分布$\pi_i(x)$将收敛到平稳分布$\pi(x)$。假设到第$n$步的时候马尔科夫链收敛，则有<br>$$<br>\begin{array}{l}<br>X_0 \sim \pi_0(x)\\<br>X_1\sim \pi_1(x)\\<br>…\\<br>X_n\sim \pi_n(x) = \pi(x)\\<br>X_{n+1}\sim \pi(x)\\<br>X_{n+2}\sim \pi(x)\\<br>…<br>\end{array}<br>$$</p>
<p>所以$X_n,X_{n+1},X_{n+2},…\sim \pi(x)$都是属于同分布的随机变量，当然他们并不是独立的。如果从$x_0$开始沿着马尔科夫链按照概率转移矩阵跳转，那么我们将会得到一个转移序列$\{x_0,x_1,…,x_n,x_{n+1},…\}$，由于马尔科夫链具有收敛性，所以$\{x_{n},x_{n+1},…\}$都是平稳分布$\pi(x)$的样本。</p>
<h5 id="_MCMC_">_MCMC_</h5><p>_定理(细致平稳条件)_ 如果非周期马尔科夫链的转移矩阵P和分布$\pi(x)$满足<br>$$\pi(i)P_{ij}=\pi(j)P_{ji}, ~for~all~ i,j$$<br>则$\pi(x)$是马尔科夫链的平稳分布，上式被称为细致平稳条件。<br>假设我们已经有了一个转移矩阵为$Q$的马尔科夫链($q(i\rightarrow j)$ 表示从状态$i$转移到状态$j$的概率)，$p(x)$表示当前的概率分布$\pi$，显然通常情况下：<br>$$p(i)q(i\rightarrow j) \ne p(j)q(j\rightarrow i)$$<br>也就是细致平稳条件不成立，所以$p(x)$不太可能是马尔科夫链的平稳分布。为了能够对$p(x)$进行抽样，我们必须对马尔科夫链进行改造，使得细致平稳条件成立。比如，引入一个接受率$\alpha(i,j)$使得<br>$$p(i)q(i\rightarrow j)\alpha(i,j) = p(j)q(j\rightarrow i)\alpha(j,i)$$<br>最简单的按照对称性，我们可以取如下$\alpha(i,j),\alpha(j,i)$使得上式成立<br>$$\alpha(i,j)=p(j)q(j\rightarrow i), ~ \alpha(j,i)=p(i)q(i\rightarrow j)$$</p>
<p>我们可以理解这个改造过程为在原来的马尔科夫链上，从状态$i$以概率$q(i\rightarrow j)$转移到状态$j$时，以概率$\alpha(i,j)$接受这个转移。所以新的马尔科夫链$Q^\prime$的转移概率为$q(i\rightarrow j)\alpha(i,j)$。<br><img src="http://7xjj3m.com1.z0.glb.clouddn.com/20150607_MCMC_1.png" alt="img"></p>
<p>上面的改造还有一个小小的问题：马尔科夫链的接受率$\alpha(i,j)$在转移过程中可能会偏小，如果这样子采样过程中马尔科夫链容易原地踏步，拒绝大量跳转，致使收敛速度太慢。为了提高采样的接受率，我们可以对接受率进行细微的修改：$$\alpha(i,j)=\min \left \{ \frac{p(j)q(j\rightarrow i) }{p(i)q(i\rightarrow j )}, 1 \right \}.$$</p>
<blockquote>
<p>Metropolis-Hastings采样算法</p>
<ol>
<li>初始化马尔科夫链初始状态$X_0=x_0$</li>
<li>对t=0,1,2…,循环以下过程进行采样<ul>
<li>第t时刻马尔科夫链状态$X_t=x_t$，采样$y\sim q(x|x_t)$</li>
<li>从均匀分布中采样$u\sim Uniform(0,1)$</li>
<li>如果$u\lt \alpha(x_t,y)$则接受转移$x_t \rightarrow y$，即$X_{t+1} = y$</li>
<li>否则不接受转移，即$X_{t+1}=x_t$</li>
</ul>
</li>
</ol>
</blockquote>
<h4 id="Gibbs_Sampling">Gibbs Sampling</h4><p>上述的Metropolis-Hasting算法也可以被应用与高维的场景，但是由于接受率的存在，算法的效率仍然较低。Gibbs Sampling，找到了一个接受率为1的转移矩阵。考察二维的情形，假设概率分布为$p(x,y)$。给定$x$坐标相同的两个点$A(x_1,y_1),B(x_1,y_2)$不难发现<br>$$<br>\begin{array}{c}<br>p(x_1,y_1)p(y_2|x_1)=p(x_1)p(y_1|x_1)p(y_2|x_1)\\<br>p(x_1,y_2)p(y_1|x_1)=p(x_1)p(y_2|x_1)p(y_1|x_1)\\<br>p(x_1,y_1)p(y_2|x_1) = p(x_1,y_2)p(y_1|x_1)\\<br>\end{array}<br>$$<br>也就是$p(A)p(y_2|x_1)=p(B)p(y_1|x_1)$。也就是说给定$x=x_1$这条平行于$y$轴的直线，使用分布$p(y|x_1$作为这条直线上任意两点的转移概率，该分布满足细致平稳条件。同样，对于点$A(x_1,y_1),C(x_2,y_1)$我们也可以得到$p(A)p(x_2|y1)=p(C)p(x_1|y_1)$。</p>
<p><img src="http://7xjj3m.com1.z0.glb.clouddn.com/20150607_Gibbs_1.png" alt="img"></p>
<p>构造如下转移矩阵<br>$$<br>\begin{array}{l}<br>Q(A\rightarrow B) = p(y_B|x_1)\\<br>Q(A\rightarrow C) = p(x_C|y_1)\\<br>Q(A\rightarrow D) = 0<br>\end{array}<br>$$<br>显然上面的转移矩阵$Q$满足细致平稳条件。于是这个二维的马尔科夫链将会收敛到平稳分布$p(x,y)$。这个算法被称为Gibbs Sampling，是由德国物理学家Gibbs首先提出的。<br>二维的算法很容易扩展到$n$维空间。对于$n$维空间的概率分布$p(x_1,x_2,…,x_n)$的转移矩阵如下：</p>
<ol>
<li>对于当前状态$(x_1,x_2,…,x_n)$，马尔科夫链只能沿着坐标轴转移。比如，但状态沿着$x_i$转移时，其马尔科夫链转移概率为$p(x_i|x_1,…,x_{i-1},x_{i+1},…,x_n)$。</li>
<li>其它无法沿着坐标轴进行跳转的转移概率均为0。</li>
</ol>
<blockquote>
<p>n维Gibbs Sampling算法</p>
<ol>
<li>随机选取一个初始状态$(x_1,x_2,…,x_n)$</li>
<li>对t=0,1,2… 循环采样：<ul>
<li>$x_1^{(t+1)}\sim p(x_1|x_2^{(t)},x_3^{(t)},…,x_n^{(t)})$</li>
<li>$x_2^{(t+1)}\sim p(x_2|x_1^{(t+1)},x_3^{(t)},…,x_n^{(t)})$</li>
<li>…</li>
<li>$x_j^{(t+1)}\sim p(x_j|x_1^{(t+1)},x_2^{(t+1)},…,x_{j-1}^{(t+1)},x_{j+1}^{(t)},…,x_n^{(t)})$</li>
<li>…</li>
<li>$x_n^{(t+1)}\sim p(x_n|x_1^{(t+1)},x_2^{(t+1)},…,x_{n-1}^{(t+1)})$</li>
</ul>
</li>
</ol>
</blockquote>

        
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Gibbs/"> #Gibbs </a>
          
            <a href="/tags/MCMC/"> #MCMC </a>
          
            <a href="/tags/采样/"> #采样 </a>
          
        </div>
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/05/27/SVM之SMO算法笔记（之二）/">
                SVM之SMO算法笔记（之二）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-05-27
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/机器学习/">机器学习</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/05/27/SVM之SMO算法笔记（之二）/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/05/27/SVM之SMO算法笔记（之二）/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>上一篇文章<a href="/2015/05/27/SVM之SMO算法笔记（之一）">《SVM之SMO算法笔记（之一）》</a>介绍了SMO算法的原理，本篇文章将要介绍算法的具体步骤。</p>
<h2 id="SMO算法的步骤">SMO算法的步骤</h2><p>我们已经知道SMO算法在每个迭代中都要选择一对$\alpha_1$和$\alpha_2$进行优化更新，可以描述为如下两个步骤：</p>
<ol>
<li>采用启发式的方法选择一对$\alpha_1$和$\alpha_2$，使得本次优化最大程度接近全局最优值。<br>(1)寻找第一个违反KKT条件的$\alpha_1$。<br>(2)在non-bounded子集中选取使得$|E_1-E_2|$最大的$\alpha_2$。</li>
<li>固定除了$\alpha_1$和$\alpha_2$之外的其他参数，对目标函数最优化求参数。</li>
</ol>
<h3 id="First_Choice">First Choice</h3><blockquote>
<p>The first choice heuristic concentrates the CPU time on the examples that are most likely to violate the KKT conditions: the non-bound subset. As the SMO algorithm progresses, Lagrange multipliers that are at the bounds are likely to stay at the bounds, while Lagrange multipliers that are not at the bounds will change as other examples are optimized.</p>
</blockquote>
<p>采用启发式的方法，先在最可能出现违反KKT条件的non-bound子集中寻找一个违背KKT条件的$\alpha$。</p>
<blockquote>
<p>The SMO algorithm will thus iterate over the non-bound subset until that subset is self-consistent, then SMO will scan the entire data set to search for any bound examples that have become KKT-violated due to optimizing the non-bound subset.</p>
</blockquote>
<p>SMO会一直迭代，直到non-bound中没有违背KKT条件的$\alpha$之后，再去扫描全集寻找违反KKT的$\alpha$。</p>
<blockquote>
<p>SMO veries that the KKT conditions are fullled within $\epsilon$. Typically,  can typically be set in the range $10^{-2}$ to $10^{-3}$.</p>
</blockquote>
<h3 id="Second_Choice">Second Choice</h3><blockquote>
<p>Evaluating the kernel function k is time consuming, so SMO approximates the step size by the absolute value of the numerator in equation (12.6): $|E_1 - E_2 |$. SMO keeps a cached error value E for every non-bound example in the training set and then chooses an error to approximately maximize the step size.</p>
</blockquote>
<p>在non-bounded的子集中选取一个使得$|E_1 - E_2|$达到最大的样本，对应的参数记作$\alpha_2$</p>
<blockquote>
<p>Under unusual circumstances, SMO cannot make positive progress using the second choice heuristic described above. For example, positive progress cannot be made if the rst and second training examples share identical input vectors $\overrightarrow{x}$, which causes the objective function to become at along the direction of optimization.</p>
</blockquote>
<h4 id="_Second_Choice_Hierarchy_">_Second Choice Hierarchy_</h4><blockquote>
<p>SMO uses a hierarchy of second choice heuristics until it nds a pair of Lagrange multipliers that can make positive progress. </p>
<p>(A) if the above heuristic does not make positive progress, then SMO starts iterating through the non-bound examples, searching for a second example that can make positive progress; </p>
<p>(B) if none of the non-bound examples make positive progress, then SMO starts iterating through the entire training set until an example is found that makes positive progress. </p>
<p>Both the iteration through the non-bound examples (A) and the iteration through the entire training set (B) are started at random locations in order not to bias SMO towards the examples at the beginning of the training set.  </p>
</blockquote>
<p>为了得到<code>positive progress</code>，选择第二个Largrange乘子的步骤如下：</p>
<ol>
<li>采用启发式的方法选择一对$\alpha_1$和$\alpha_2$，使得本次优化最大程度接近全局最优值。<br>(1). 寻找第一个违反KKT条件的$\alpha_1$。<br>(2). 寻找第二个Largrange乘子。<br>　(a). 在non-bounded子集中选取使得$|E_1-E_2|$最大的$\alpha_2$。<br>　(b). 如果(a)中没有达到<code>positive progress</code>，SMO搜寻所有的non-bounded直到有<code>positive progress</code>。<br>　(c). 如果(b)中没有达到<code>positive progress</code>，SMO搜寻集合中的所有元素，直到找到<code>positive progress</code>。<br>　(d). (b)和(c)的搜寻起点都是随机挑选的。</li>
</ol>
<h3 id="Error_Cache">Error Cache</h3><blockquote>
<p>Whenever a joint optimization occurs, the stored errors for all non-bound multipliers k that are not involved in the optimization are updated according to<br>$$E_k^{new} = E_k^{old} +  y_1(\alpha_1^{new} - \alpha_1^{old} )\kappa(x_1,x_k) +y_2(\alpha_2^{new,clipped} - \alpha_2^{old}  )\kappa(x_2,x_k) + b^{old} - b^{new}$$</p>
<p>When an error E is required by SMO, it will look up the error in the error cache if the corresponding Lagrange multiplier is not at bound. Otherwise, it will evaluate the current SVM decision function based on the current $\alpha$ vector.  </p>
</blockquote>
<h4 id="Java_实现">Java 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ac.ict.textclass.classifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ac.ict.textclass.kernel.Kernel;</span><br><span class="line"><span class="keyword">import</span> cn.ac.ict.textclass.kernel.LinearKernel;</span><br><span class="line"><span class="keyword">import</span> cn.ac.ict.textclass.kernel.RBFKernel;</span><br><span class="line"><span class="keyword">import</span> cn.ac.ict.textclass.kernel.TanhKernel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SVM</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Logger logger = Logger.getLogger(SVM.class);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> alpha[];</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> C;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> tol;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> x[][];</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> kappa[][];</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> y[];</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> E[];</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> b;<span class="comment">//the threshold</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> bound[];</span><br><span class="line">	<span class="keyword">private</span> Kernel kernel;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> ITER = <span class="number">1000</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> min_value = <span class="number">0.00000000001</span>; </span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SVM</span><span class="params">(Kernel kernel)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.kernel = kernel;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">config</span><span class="params">(<span class="keyword">double</span> C,<span class="keyword">double</span> tol,<span class="keyword">int</span> iter)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.C = C;</span><br><span class="line">		<span class="keyword">this</span>.tol = tol;</span><br><span class="line">		<span class="keyword">this</span>.ITER = iter;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">function</span><span class="params">(<span class="keyword">int</span> I)</span></span>&#123;</span><br><span class="line">		<span class="keyword">double</span> res = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; alpha.length; ++ i )&#123;</span><br><span class="line">			res += alpha[i]*y[i]*kappa[i][I];</span><br><span class="line">		&#125;</span><br><span class="line">		res -= b;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">getE</span><span class="params">(<span class="keyword">int</span> I)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>( bound[I] )&#123;<span class="comment">//cached non-bound error</span></span><br><span class="line">			E[I] = function(I) - y[I];</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> E[I]; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">double</span> [][]x ,<span class="keyword">int</span> []y)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.x = x;</span><br><span class="line">		<span class="keyword">this</span>.y = y;</span><br><span class="line">		<span class="keyword">int</span> len = y.length;</span><br><span class="line">		alpha = <span class="keyword">new</span> <span class="keyword">double</span>[len];</span><br><span class="line">		E = <span class="keyword">new</span> <span class="keyword">double</span>[len];</span><br><span class="line">		bound = <span class="keyword">new</span> <span class="keyword">boolean</span>[len];</span><br><span class="line">		kappa = <span class="keyword">new</span> <span class="keyword">double</span>[len][len];</span><br><span class="line">		b = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; ++ i )&#123;</span><br><span class="line">			alpha[i] = <span class="number">0</span>;</span><br><span class="line">			bound[i] = <span class="keyword">true</span>;</span><br><span class="line">			E[i] = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; ++ i )&#123;</span><br><span class="line">			<span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= i; ++ j)&#123;</span><br><span class="line">				kappa[i][j] = kernel.getKappa(x[i], x[j]);</span><br><span class="line">				kappa[j][i] = kappa[i][j];</span><br><span class="line">				System.out.print(kappa[i][j] + <span class="string">" "</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.println();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="javadoc">/**</span><br><span class="line">	 * </span><br><span class="line">	 *<span class="javadoctag"> @param</span> i1</span><br><span class="line">	 *<span class="javadoctag"> @param</span> i2</span><br><span class="line">	 *<span class="javadoctag"> @return</span></span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">takeStep</span><span class="params">(<span class="keyword">int</span> i1,<span class="keyword">int</span> i2)</span></span>&#123;	</span><br><span class="line">		<span class="keyword">if</span>( i1 == i2 )&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> s = y[i1]*y[i2];</span><br><span class="line">		<span class="keyword">double</span> E1 = getE(i1);</span><br><span class="line">		<span class="keyword">double</span> E2 = getE(i2);</span><br><span class="line">		<span class="keyword">double</span> L,H;<span class="comment">//for alpha[i2]</span></span><br><span class="line">		<span class="keyword">if</span>( s != <span class="number">1</span> )&#123;</span><br><span class="line">			L = Math.max(<span class="number">0</span>, alpha[i2] - alpha[i1] );</span><br><span class="line">			H = Math.min(C, C + alpha[i2] - alpha[i1]);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			L = Math.max(<span class="number">0</span>, alpha[i2] + alpha[i1] - C );</span><br><span class="line">			H = Math.min(C, alpha[i2] + alpha[i1]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>( Math.abs(L -H) &lt; min_value )&#123;</span><br><span class="line">			logger.info( <span class="string">" L == H , return false"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">double</span> k12 = kappa[i1][i2];</span><br><span class="line">		<span class="keyword">double</span> k11 = kappa[i1][i1];</span><br><span class="line">		<span class="keyword">double</span> k22 = kappa[i2][i2];</span><br><span class="line">		<span class="keyword">double</span> eta = <span class="number">2</span>*k12 - k11 - k22;</span><br><span class="line">		<span class="keyword">double</span> new_alpha_2 = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>( eta &lt; <span class="number">0</span> )&#123;<span class="comment">//assert eta &lt;= 0</span></span><br><span class="line">			new_alpha_2 = alpha[i2] - y[i2]*(E1-E2)/eta;</span><br><span class="line"><span class="comment">//			logger.info("new_alpha_2 = " + new_alpha_2 +", E1 = " +E1+", E2 = "+E2 +", L = " + L +", H = "+H);</span></span><br><span class="line">			<span class="keyword">if</span>( new_alpha_2 &lt; L ) new_alpha_2 = L;</span><br><span class="line">			<span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">( new_alpha_2 &gt; H )</span> new_alpha_2 </span>= H;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;<span class="comment">// eta == 0 in this case, which doesn't make positive progress.</span></span><br><span class="line">			<span class="comment">/*</span><br><span class="line">			Under unusual circumstances, eta will not be negative. A zero eta can occur if more than one training</span><br><span class="line">			example has the same input vector X. If eta==0, we need to evaluate the objective function at the two </span><br><span class="line">			endpoints, i.e. at L and H, and set a2(第二个乘子的新值) to be the one with larger objective function </span><br><span class="line">			value. The objective function is: obj=eta*a2^2/2 + (y2*(E1-E2)-eta*alph2)*a2+const</span><br><span class="line">			*/</span></span><br><span class="line">			<span class="keyword">double</span> c1 = eta/<span class="number">2</span>;</span><br><span class="line">			<span class="keyword">double</span> c2 = y[i2]*(E1-E2) - eta*alpha[i2];</span><br><span class="line">			<span class="keyword">double</span> Lobj = c1 *L*L + c2*L;<span class="comment">// objective function at alpha_j = L</span></span><br><span class="line">			<span class="keyword">double</span> Hobj = c1 *H*H + c2*H;<span class="comment">// objective function at alpha_j = H</span></span><br><span class="line">			<span class="keyword">if</span>( Lobj &gt; Hobj + min_value )&#123;</span><br><span class="line">				new_alpha_2 = L;</span><br><span class="line">			&#125;<span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">( Lobj &lt; Hobj - min_value )</span></span>&#123;</span><br><span class="line">				new_alpha_2 = H;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				new_alpha_2 = alpha[i2];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//return false;</span></span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">//		logger.info("na2 = " + new_alpha_2 );</span></span><br><span class="line">		<span class="keyword">if</span>( new_alpha_2 &lt; min_value )&#123;</span><br><span class="line">			new_alpha_2 = <span class="number">0</span>;</span><br><span class="line">		&#125;<span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">( new_alpha_2 &gt; C - min_value )</span></span>&#123;</span><br><span class="line">			new_alpha_2 = C;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//doesn't make positive progress</span></span><br><span class="line">		<span class="keyword">if</span>( Math.abs(new_alpha_2 - alpha[i2] ) &lt; min_value )&#123;</span><br><span class="line">			logger.info(<span class="string">"doesn't make positive progress, return false"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">double</span> new_alpha_1 = alpha[i1] + s*(alpha[i2] - new_alpha_2);</span><br><span class="line">		<span class="keyword">if</span>( <span class="number">0</span> &lt; new_alpha_1 &amp;&amp; new_alpha_1&lt;  C  )&#123;</span><br><span class="line">			bound[i1] = <span class="keyword">false</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			bound[i1] = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>( <span class="number">0</span> &lt; new_alpha_2 &amp;&amp; new_alpha_2&lt;  C  )&#123;</span><br><span class="line">			bound[i2] = <span class="keyword">false</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			bound[i2] = <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*update parameters*/</span> </span><br><span class="line">		<span class="keyword">double</span> b1 = b + E1 + y[i1]*( new_alpha_1 - alpha[i1])*k11 + y[i2]*(new_alpha_2 - alpha[i2])*k12;</span><br><span class="line">		<span class="keyword">double</span> b2 = b + E2 + y[i1]*( new_alpha_1 - alpha[i1])*k12 + y[i2]*(new_alpha_2 - alpha[i2])*k22;</span><br><span class="line">		<span class="keyword">double</span> nb;</span><br><span class="line">		<span class="keyword">if</span>( !bound[i1] )&#123;</span><br><span class="line">			nb = b1;</span><br><span class="line">		&#125;<span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">( !bound[i2] )</span></span>&#123;</span><br><span class="line">			nb = b2;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			nb = (b1+b2)/<span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/*update all cache error for non-bound examples*/</span></span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; E.length; ++ k )&#123;</span><br><span class="line">			<span class="keyword">if</span>( !bound[k])&#123;</span><br><span class="line">				E[k] = E[k] + y[i1]*(new_alpha_1 - alpha[i1])*kappa[k][i1] + y[i2]*(new_alpha_2 - alpha[i2])*kappa[k][i2] + b - nb;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		b = nb;</span><br><span class="line">		alpha[i1] = new_alpha_1;</span><br><span class="line">		alpha[i2] = new_alpha_2;</span><br><span class="line"><span class="comment">//		logger.info("a1 = " + alpha[i1] +", a2 = " + alpha[i2]);</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; E.length; ++ k )&#123;</span><br><span class="line">				<span class="keyword">double</span> tE = function(k) - y[k];</span><br><span class="line">				System.out.print(tE +<span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; alpha.length; ++ i )&#123;</span><br><span class="line">			System.out.print( alpha[i] +<span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(b);</span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bound.length; ++ i )&#123;</span><br><span class="line">			System.out.print( bound[i] +<span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="javadoc">/**</span><br><span class="line">	 * Examine whether example I violate KKT condition. If yes, update it. </span><br><span class="line">	 *<span class="javadoctag"> @param</span> I example I</span><br><span class="line">	 *<span class="javadoctag"> @return</span> if update success return true, else false.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">examine</span><span class="params">(<span class="keyword">int</span> I)</span></span>&#123;</span><br><span class="line">		<span class="keyword">double</span> EI = getE(I);</span><br><span class="line">		<span class="keyword">double</span> r = EI*y[I];</span><br><span class="line">		logger.info(<span class="string">" EI = "</span>+EI+<span class="string">", r = "</span>+r);</span><br><span class="line">		<span class="comment">/*</span><br><span class="line">		 * KKT condition</span><br><span class="line">		 * alpha == 0  &lt;==&gt; yi*f(xi) &gt;= 1 &lt;==&gt; yi*Ei &gt;= 0 </span><br><span class="line">		 * 0&lt; alpha &lt;C &lt;==&gt; yi*f(xi) == 1 &lt;==&gt; yi*Ei == 0 ( support vector )</span><br><span class="line">		 * alpha == C  &lt;==&gt; yi*f(xi) &lt;= 1 &lt;==&gt; yi*Ei &lt;= 0 </span><br><span class="line">		 * </span><br><span class="line">		 * It obeys KKT, if r &lt; 0 and alpha &lt; C;</span><br><span class="line">		 * Because alpha == C when r &lt; 0 under KKT condition.</span><br><span class="line">		 * Also it obeys KKT, if r &gt; 0 and alpha &gt; 0;</span><br><span class="line">		 * Because alpha == 0 when r &gt; 0 under KKT condition. </span><br><span class="line">		 */</span></span><br><span class="line">		<span class="keyword">if</span>( ( r &lt; -tol &amp;&amp; alpha[I] &lt; C ) || ( r &gt; tol &amp;&amp; alpha[I] &gt; <span class="number">0</span> ) )<span class="comment">//obey KKT condition</span></span><br><span class="line">		&#123;</span><br><span class="line">			logger.info(<span class="string">"sample "</span> + I +<span class="string">" violates KKT."</span>);</span><br><span class="line">			<span class="keyword">double</span> max = -<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">int</span> J = -<span class="number">1</span>;</span><br><span class="line">			<span class="comment">/*Hierarchy 1: select alpha which maximizes |E1-E2| from non-bound alphas*/</span></span><br><span class="line">			<span class="keyword">for</span>( <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; bound.length; ++ j )&#123;<span class="comment">//select </span></span><br><span class="line">				<span class="keyword">if</span>( I == j || bound[j]) <span class="keyword">continue</span>;</span><br><span class="line">				<span class="keyword">double</span> Ej = getE(j);</span><br><span class="line">				<span class="keyword">if</span>( Math.abs( EI - Ej ) &gt; max )&#123;</span><br><span class="line">					max = Math.abs(EI - Ej);</span><br><span class="line">					J = j;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>( J &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">				logger.info(<span class="string">"Hierarchy 1: J = "</span> + J );</span><br><span class="line">				<span class="keyword">if</span>(takeStep(J,I))<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/*Hirearchy 2: scan non-bound subset started at random location until it makes positive progress*/</span></span><br><span class="line">			<span class="keyword">int</span> rand = (<span class="keyword">int</span>)Math.random()*bound.length;</span><br><span class="line">			<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; bound.length; ++ i)&#123;</span><br><span class="line">				<span class="keyword">int</span> j = (rand+i)%bound.length;</span><br><span class="line">				<span class="keyword">if</span>( I == j || bound[j] || j == J) <span class="keyword">continue</span>;</span><br><span class="line">				logger.info(<span class="string">"Hierarchy 2: J = "</span> + j );</span><br><span class="line">				<span class="keyword">if</span>( takeStep(j,I) ) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/*Hierarchy 3: scan the entire train set( exclusive non-bound ) started at random location until it makes positive progress*/</span></span><br><span class="line">			rand = (<span class="keyword">int</span>)Math.random()*bound.length;</span><br><span class="line">			<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; y.length; ++ i )&#123;</span><br><span class="line">				<span class="keyword">int</span> j = (rand+i)%bound.length;</span><br><span class="line">				<span class="keyword">if</span>( I == j || !bound[j]) <span class="keyword">continue</span>;</span><br><span class="line">				logger.info(<span class="string">"Hierarchy 3: J = "</span> + j );</span><br><span class="line">				<span class="keyword">if</span>( takeStep(j,I)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">train</span><span class="params">(<span class="keyword">double</span> x[][],<span class="keyword">int</span> y[])</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>( x.length != y.length )&#123;</span><br><span class="line">			System.out.println( <span class="string">"The input vectors' length are not the same."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		init(x,y);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> numChanged = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">boolean</span> examineAll = <span class="keyword">true</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> iter = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">/*</span><br><span class="line">		while( iter ++ &lt; ITER )&#123;</span><br><span class="line">			for( int i = 0; i &lt; alpha.length; ++ i )&#123;</span><br><span class="line">				examine( i );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;*/</span></span><br><span class="line">		<span class="keyword">while</span>( iter++ &lt; ITER &amp;&amp; (numChanged&gt;<span class="number">0</span> || examineAll ))&#123;</span><br><span class="line">			numChanged = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span>( examineAll )&#123;</span><br><span class="line">				<span class="comment">//loop I over all training examples</span></span><br><span class="line">				<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; alpha.length; ++ i )&#123;</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span>( examine(i) )</span><br><span class="line">						numChanged += <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="comment">//loop I over examples where alpha is not 0 &amp; not C, non-bound subset</span></span><br><span class="line">				<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; alpha.length; ++ i )&#123;</span><br><span class="line">					<span class="keyword">if</span>( !bound[i] )&#123;</span><br><span class="line">						<span class="keyword">if</span>( examine(i) )</span><br><span class="line">							numChanged += <span class="number">1</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			</span><br><span class="line">			&#125;</span><br><span class="line"><span class="comment">//			logger.info("numChanged = " + numChanged);</span></span><br><span class="line">			<span class="keyword">if</span>( examineAll ) examineAll = <span class="keyword">false</span>;</span><br><span class="line">			<span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">( numChanged == <span class="number">0</span> )</span></span>&#123;</span><br><span class="line">				examineAll = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		System.out.println( <span class="string">"iter "</span> + iter );</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">predict</span><span class="params">(<span class="keyword">double</span> x[])</span></span>&#123;</span><br><span class="line">		<span class="keyword">double</span> res = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; x.length; ++ i )&#123;</span><br><span class="line">			<span class="keyword">if</span>( alpha[i] &lt; min_value )<span class="keyword">continue</span>;</span><br><span class="line">			res += y[i] * alpha[i]* kernel.getKappa(x, <span class="keyword">this</span>.x[i]);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">//		System.out.println(b);</span></span><br><span class="line">		res -= b;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printParameters</span><span class="params">()</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> y[] = &#123;-<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>,<span class="number">1</span>,-<span class="number">1</span>&#125;;</span><br><span class="line">		<span class="keyword">double</span> x[][] = &#123;</span><br><span class="line">				&#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>&#125;,</span><br><span class="line">				&#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;,</span><br><span class="line">				&#123;<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">				&#123;<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>&#125;,</span><br><span class="line">				&#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;,</span><br><span class="line">				&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">				&#123;<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">double</span> xt [][] =&#123;</span><br><span class="line">				&#123;<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>,<span class="number">4</span>&#125;,</span><br><span class="line">				&#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;,</span><br><span class="line">				&#123;<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">				&#123;<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>&#125;,</span><br><span class="line">				&#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;,</span><br><span class="line">				&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">				&#123;<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"><span class="comment">//		Kernel kernel = new LinearKernel();</span></span><br><span class="line"><span class="comment">//		Kernel kernel = new RBFKernel();</span></span><br><span class="line">		TanhKernel kernel = <span class="keyword">new</span> TanhKernel();</span><br><span class="line">		kernel.config(<span class="number">0.01</span>, <span class="number">1</span>);</span><br><span class="line">		SVM svm = <span class="keyword">new</span> SVM(kernel);</span><br><span class="line">		svm.config(<span class="number">10</span>, <span class="number">0.001</span>,<span class="number">100</span>);</span><br><span class="line">		svm.train(x, y);</span><br><span class="line">		<span class="keyword">for</span>( <span class="keyword">double</span> t [] : xt )&#123;</span><br><span class="line">			System.out.println(<span class="string">""</span>+ svm.predict(t) + <span class="string">" "</span> + (svm.predict(t) &gt; <span class="number">0</span> ? <span class="number">1</span> : - <span class="number">1</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SVM/"> #SVM </a>
          
        </div>
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/05/27/SVM之SMO算法笔记（之一）/">
                SVM之SMO算法笔记（之一）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2015-05-27
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/机器学习/">机器学习</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/05/27/SVM之SMO算法笔记（之一）/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/05/27/SVM之SMO算法笔记（之一）/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>参考《支持向量机通俗导论》<br>关于SVM的原理和理论推导可以查阅July的博客<a href="http://blog.csdn.net/v_july_v/article/details/7624837" target="_blank" rel="external">《支持向量机同属导论》</a>。这篇博客关注SVM的实现。</p>
<h3 id="SMO算法">SMO算法</h3><p>　首先，SVM的模型求解的问题是去寻找一个最优分类面：<br>$$f(x)=w^Tx-b. \tag{1}\label{eq:1}$$<br>　SVM的最优化目标等价于：<br>$$<br>        \begin{array}{l}<br>       \min_{w,b} \frac12||w||^2  \\<br>        s.t. y_i(w^Tx_i-b)\ge 1, i = 1,2,…,n \\<br>        \end{array}.\tag{2}<br>$$<br>　可以应用Largrange对偶性，通过求解对偶问题得到最优解。引入Largrange乘数乘子$\alpha$，将约束项融合到目标函数中去：<br>$$L(w,b,\alpha)=\frac{1}{2}||w||^2-\sum_{i=1}^{n}{\alpha_i(y_i(w^Tx_i-b)-1)}. \tag{3}$$<br>　固定$\alpha$，可以求得参数：</p>
<p><center><br>$\frac{\partial L}{\partial w} = 0 \Rightarrow  w=\sum_{i=1}^{n}y_i\alpha_i x_i \tag{4}\label{eq:4},$<br>$\frac{\partial L}{\partial b} = 0 \Rightarrow \sum_{i=1}^{n} \alpha_i yi = 0, \tag{5}$<br>$b = w^Tx_i - y_i ( \alpha_i &gt; 0 ). \tag{6}$</center><br>将公式$\eqref{eq:4}$代入公式$\eqref{eq:1}$可以得到：<br>$$f(x)=\sum_{i=1}^{n}{y_i\alpha_i \kappa(x_i,x)} -b. \tag{7}$$<br>所以，支持向量机的所有参数$\Theta=\{\alpha_i,b | i = 1,2,…,n\}$.</p>
<h4 id="引入松弛变量之后的SVM">引入松弛变量之后的SVM</h4><p>QP问题为：</p>
<p>$$<br>\begin{array}{l}<br>    \min_{w,b}=\frac{1}{2}||w||^2+C\sum_{i=1}^{n}{\xi_i} \\<br>    s.t. y_i(w^Tx_i - b)&gt;1-\xi_i, i = 1,2,…,n\\<br>\end{array}. \tag{8}$$<br>最终的优化目标为：<br>$$\min_{w,b}=\frac{1}{2}\sum_{i=1}^{n}{\sum_{j=1}^{n}{\alpha_i\alpha_j y_i y_j \kappa(x_i,x_j)}}-\sum_{i=1}^{n}{\alpha_i}. \tag{9}$$<br>$$s.t. 0 \le \alpha_i \le C, i = 1,2,…,n \\ \sum_{i=1}^{n}{\alpha_i y_i}=0$$</p>
<h4 id="KKT条件">KKT条件</h4><ul>
<li>最优解需要满足KKT条件，KKT条件：<br>$$<br>\begin{array}{ccc}<br>  \alpha_i = 0 &amp;\Leftrightarrow &amp;y_if(x_i) \ge 1 \\<br>   0 &lt; \alpha_i &lt;C &amp;\Leftrightarrow&amp; y_if(x_i) = 1 \\<br>   \alpha_i = C &amp;\Leftrightarrow &amp;y_if(x_i) \le 1\\<br>\end{array}$$</li>
<li>当出现如下情况时违背了KKT条件：</li>
</ul>
<ol>
<li>$ y_i( f(x_i) - y_i ) &gt;0,\alpha_i &gt; 0$时不满足；因为此时$\alpha_i = 0$应该被满足。</li>
<li>$ y_i( f(x_i) - y_i ) &lt;0 , \alpha_i &lt; C$时不满足；因为此时$\alpha_i=C$应该被满足。</li>
</ol>
<p>所以SMO算法的思想就是找出不满足KKT条件的$\alpha_i$，并更新这些$\alpha_i$。</p>
<h4 id="$\alpha$受到的约束条件">$\alpha$受到的约束条件</h4><p>除了更新不满足KKT条件的$\alpha_i$，所有$\alpha$还要受到约束：$\sum_{i=1}^{n}{\alpha_i y_i} = 0$。<br>为此SMO同时更新两个参数，假设这两个参数分别为$\alpha_i,\alpha_j$，并使得$\alpha_i^{new},\alpha_j^{new}$满足：</p>
<p><center>$y_i\alpha_i^{new}+y_j\alpha_j^{new}=y_i\alpha_i^{old}+y_j\alpha_j^{old}=\gamma$</center><br>再考虑$0 \le \alpha\le C$，$\alpha_i,\alpha_j$的取值范围如下图所示（图中正方形内部线段的取值范围）：</p>
<p>根据上图，可以得到$\alpha_j$的取值上下限如下：<br>$L=max(0,\alpha_j^{old}-\alpha_i^{old}), H=min(C,C+\alpha_j^{old} - \alpha_i^{old}), y_j \ne y_i$<br>$L=max(0,\alpha_j^{old}+\alpha_i^{old}-C), H=min(C,\alpha_j^{old} + \alpha_i^{old}), y_j = y_i $</p>
<h4 id="更新$\alpha$">更新$\alpha$</h4><p>每次更新的时候总有：<br>$$\alpha_{j}^{new} = \alpha_j^{old} - \frac{y_j(E_i-E_j)}{\eta}$$<br>$$\alpha_{j}^{new,clipped} = \left\{<br>\begin{array}{cc}<br>H,&amp;\alpha_i^{new} \ge H\\<br>\alpha_i^{new}, &amp; L&lt; \alpha_i^{new} &lt;H\\<br>L, &amp;\alpha_i^{new} \le L \end{array}<br>\right.$$<br>$$\alpha_{i}^{new} = \alpha_i^{old} + y_iy_j(\alpha_j^{old} - \alpha_j^{new,clipped})$$<br>其中$E_i$和$E_j$表示error( $E=f(x) - y$)<br>$$\eta = 2\kappa(x_i,x_j) - \kappa(x_i,x_i) - \kappa(x_j,x_j)$$</p>
<h4 id="更新模型参数">更新模型参数</h4><p>每次更新完$\alpha_i,\alpha_j$都要重新计算模型参数$b$，以及$E$.</p>
<p>$$<br>\left\{<br>\begin{array}{c}<br>b_1 = b^{old} + E_i +y_i(\alpha_i^{new} - \alpha_i^{old} )\kappa(x_i,x_i) + y_j(\alpha_j^{new,clipped} - \alpha_j^{old}  )\kappa(x_i,x_j) \\<br>b_2 = b^{old} + E_j + y_i(\alpha_i^{new} - \alpha_i^{old} )\kappa(x_i,x_j) +y_j(\alpha_j^{new,clipped} - \alpha_j^{old}  )\kappa(x_j,x_j) \\<br>\end{array}<br>\right.$$</p>
<blockquote>
<p>Whenever a joint optimization occurs, the stored errors for all non-bound multipliers k that are not involved in the optimization are updated according to<br>$$E_k^{new} = E_k^{old} +  y_i(\alpha_i^{new} - \alpha_i^{old} )\kappa(x_i,x_k) +y_j(\alpha_j^{new,clipped} - \alpha_j^{old}  )\kappa(x_j,x_k) + b^{old} - b^{new}$$</p>
<p>When an error E is required by SMO, it will look up the error in the error cache if the corresponding Lagrange multiplier is not at bound. Otherwise, it will evaluate the current SVM decision function based on the current $\alpha$ vector.  </p>
</blockquote>

        
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SVM/"> #SVM </a>
          
        </div>
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
  </div>

  

        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/images/avatar.jpg" alt="fortianyou" />
          <p class="site-author-name">fortianyou</p>
        </div>
        <p class="site-description motion-element">不积跬步无以至千里，不积小流无以成江海</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">3</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">2</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/fortianyou" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/u/2824731241" target="_blank">Weibo</a>
            </span>
            
          
        </div>

        
        

      </div>

      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">fortianyou</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('.content img').each(function () {
        var $image = $(this);
        var $imageWrapLink = $image.parent('a');

        if ($imageWrapLink.size() < 1) {
          $imageWrapLink = $image.wrap('<a href="' + this.getAttribute('src') + '"></a>').parent('a');
        }
        $imageWrapLink.addClass('fancybox');
      });
    });
    $('.fancybox').fancybox({
      helpers: {
        overlay: {
          locked: false
        }
      }
    });
  </script>


  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }

  function displaySidebar () {
    setTimeout(function () {
      $('.sidebar-toggle').trigger('click');
    }, 800);
  }
</script>

  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    LogoAndMenuMotion();
    sidebarToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});

    function LogoAndMenuMotion() {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        
        { e: $('.logo-line-before i'), p: { translateX: "100%" }, o: { duration: 500, sequenceQueue: false } },
        { e: $('.logo-line-after i'), p: { translateX: "-100%" }, o: { duration: 500, sequenceQueue: false } },
        
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200 } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    }


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        display: 'block',
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      var postMotionOptions = window.postMotionOptions || {stagger: 300, drag: true};
      $('.post').velocity('transition.slideDownIn', postMotionOptions);
    }

    function sidebarToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  

  <script type="text/javascript">
    var HEXO_SIDEBAR_CONFIGURATION = 'hide';
    $(document).ready(function () {
      if (HEXO_SIDEBAR_CONFIGURATION === 'always') {
        displaySidebar();
      }
    });
  </script>

  
<script type="text/x-mathjax-config">
    MathJax.Hub.Config(
	{"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    }); 
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  
  

  

    
      
    

    <script type="text/javascript">
      var disqus_shortname = 'fortianyou';
      var disqus_identifier = 'index.html';
      var disqus_title = '';
      var disqus_url = '';

      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>
  




  
  
</body>
</html>
